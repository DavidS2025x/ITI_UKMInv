<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="Icons\UKM_InvDB_Transparent_Alt.ico">
    <title>Uredi uporabnika</title>
    <script src="JS/main.js" type="module"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="CSS\style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script>

</head>
<body>
    <!-- NAVIGATION -->
    <!-- FORM -->
</body>

<script>
    window.addEventListener("DOMContentLoaded", () => {
                uporabnikPodatki()
                .then(data => {
                    // Update navbar with user info
                    document.getElementById('username').textContent = data.Ime + ' ' + data.Priimek;
                    // Generate action buttons based on permissions
                    addNavigationLinks(data)
                    .then(() => {
                        const currentWindow = window.location.pathname.split('/').pop();
                        const links = document.querySelectorAll('#navLinksContainer .nav-link');
                        links.forEach(link => {
                            if (link.getAttribute('href').includes(currentWindow)) {
                                link.classList.add('active');
                            }
                        });
                    });
                }).catch(err => {
                    console.error('Error loading user data:', err);
                });

                const naslov = document.getElementById("naslov")
                naslov.innerText = "Uredi uporabnika";

                fetch('/vlogaPodatki')
                .then(response => response.json())
                .then(data => {
                    const input = document.getElementById('OznakaVloge')
                    data.forEach(data => {
                        const option = document.createElement('option');
                        option.value = data.OznakaVloge;
                        option.innerText = data.NazivVloge;
                        input.appendChild(option);
                    });
                });

                fetch('/uporabnikPodatkiEdit')
                .then(response => response.json())
                .then( data => {
                    window.UporabniskoIme = data.UporabniskoIme;
                    window.Ime = data.Ime;
                    window.Priimek = data.Priimek;
                    window.Geslo = data.Geslo;
                    window.OznakaVloge = data.OznakaVloge;

                    document.getElementById('UporabniskoIme').value = window.UporabniskoIme;
                    document.getElementById('Ime').value = window.Ime;
                    document.getElementById('Priimek').value = window.Priimek;
                    document.getElementById('Geslo').value = window.Geslo;
                    document.getElementById('OznakaVloge').value = window.OznakaVloge;
                })

                document.addEventListener('submit', (event) => {
                    event.preventDefault();
                    const form = event.target;
                    const payload = {
                        UporabniskoIme: form.UporabniskoIme.value,
                        Ime: form.Ime.value,
                        Priimek: form.Priimek.value,
                        Geslo: form.Geslo.value,
                        OznakaVloge: form.OznakaVloge.value,
                        ID: window.UporabniskoIme
                    };
                    fetch('/urediUporabnika', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    })
                    .then(response => {
                        if (response.ok) {
                            alert('Uporabnik uspeÅ¡no urejen!');
                            window.location.href = '/osebaPregled';
                        } else {
                            response.json().then(j => console.error(j)).catch(()=>{});
                            alert('Napaka pri urejanju uporabnika.');
                        }
                    })
                    .catch(error => {
                        console.error('Error submitting form:', error);
                        alert('Napaka pri urejanju uporabnika.');
                    });
                });

                document.addEventListener('reset', (e) => {
                    e.preventDefault();
                    document.getElementById('UporabniskoIme').value = window.UporabniskoIme;
                    document.getElementById('Ime').value = window.Ime;
                    document.getElementById('Priimek').value = window.Priimek;
                    document.getElementById('Geslo').value = window.Geslo;
                    document.getElementById('OznakaVloge').value = window.OznakaVloge;
                });
            });
</script>