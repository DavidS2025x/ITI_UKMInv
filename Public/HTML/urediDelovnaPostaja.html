<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="Icons\UKM_InvDB_Transparent_Alt.ico">
    <title>Uredi delovno postajo</title>
    <script src="JS/main.js" type="module"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="CSS\style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script>

</head>
<body>
    <!-- NAVIGATION -->
    <!-- FORM -->
</body>
<script>
    window.addEventListener("DOMContentLoaded", () => {
                uporabnikPodatki()
                .then(data => {
                    // Update navbar with user info
                    document.getElementById('username').textContent = data.Ime + ' ' + data.Priimek;
                    // Generate action buttons based on permissions
                    addNavigationLinks(data)
                    .then(() => {
                        const currentWindow = window.location.pathname.split('/').pop();
                        const links = document.querySelectorAll('#navLinksContainer .nav-link');
                        links.forEach(link => {
                            if (link.getAttribute('href').includes(currentWindow)) {
                                link.classList.add('active');
                            }
                        });
                    });
                }).catch(err => {
                    console.error('Error loading user data:', err);
                });

                fetch('/proizvajalecPodatkiForm')
                .then(response => response.json())
                .then(data => {
                    const input = document.getElementById('OznakaProizvajalca');
                    data.forEach(data => {
                        const option = document.createElement('option');
                        option.value = data.OznakaProizvajalca;
                        option.textContent = data.NazivProizvajalca;
                        input.appendChild(option);
                    });
                });

                fetch('/tipNapravePodatkiForm')
                .then(response => response.json())
                .then(data => {
                    const input = document.getElementById('OznakaTipaNaprave');
                    data.forEach(data => {
                        const option = document.createElement('option');
                        option.value = data.OznakaTipaNaprave;
                        option.textContent = data.OpisTipaNaprave;
                        input.appendChild(option);
                    });
                });

                fetch('/lokacijaPodatkiForm')
                .then(response => response.json())
                .then(data => {
                    const input = document.getElementById('OznakaLokacije');
                    data.forEach(data => {
                        const option = document.createElement('option');
                        option.value = data.OznakaLokacije;
                        option.textContent = data.NazivLokacije;
                        input.appendChild(option);
                    });
                });

                fetch('/osebaPodatkiForm')
                .then(response => response.json())
                .then(data => {
                    const input = document.getElementById('OznakaOsebeUporabniskoIme');
                    data.forEach(data => {
                        const option = document.createElement('option');
                        option.value = data.UporabniskoIme;
                        option.textContent = data.Ime;
                        input.appendChild(option);
                    });
                });

                fetch('/sluzbaPodatkiForm')
                .then(response => response.json())
                .then(data => {
                    const input = document.getElementById('OznakaSluzbe');
                    data.forEach(data => {
                        const option = document.createElement('option');
                        option.value = data.OznakaSluzbe;
                        option.textContent = data.NazivSluzbe;
                        input.appendChild(option);
                    });
                });
                
                fetch('/enotaPodatkiForm')
                .then(response => response.json())
                .then(data => {
                    const input = document.getElementById('OznakaEnote');
                    data.forEach(data => {
                        const option = document.createElement('option');
                        option.value = data.OznakaEnote;
                        option.textContent = data.NazivEnote;
                        input.appendChild(option);
                    });
                });

                fetch('/operacijskiSistemPodatkiForm')
                .then(response => response.json())
                .then(data => {
                    const input = document.getElementById('OznakaOS');
                    data.forEach(data => {
                        const option = document.createElement('option');
                        option.value = data.OznakaOS;
                        option.innerText = data.OznakaOS;
                        input.appendChild(option);
                    });
                });

                const naslov = document.querySelector('h1')
                naslov.innerText = "Uredi delovno postajo";

                function formatDateForInput(dateString) {
                    if (!dateString) return '';
                    // Handle both "YYYY-MM-DD HH:MM:SS" and "YYYY-MM-DD" formats
                    const dateOnly = dateString.split('T')[0] || dateString.split(' ')[0];
                    return dateOnly;
                }

                fetch('/delovnaPostajaPodatkiEdit')
                .then(response => response.json())
                .then( data => {
                    console.log('Raw data from server:', data);
                    console.log('DatumProizvodnje before format:', data.DatumProizvodnje);
                    console.log('DatumNakupa before format:', data.DatumNakupa);
                    
                    window.OznakaDP = data.OznakaDP;
                    window.ModelDP = data.ModelDP;
                    window.OznakaProizvajalca = data.OznakaProizvajalca;
                    window.OznakaTipaNaprave = data.OznakaTipaNaprave;
                    window.OznakaLokacije = data.OznakaLokacije;
                    window.InventarnaStevilka = data.InventarnaStevilka;
                    window.OznakaOsebeUporabniskoIme = data.OznakaOsebeUporabniskoIme;
                    window.OznakaEnote = data.OznakaEnote;
                    window.OznakaSluzbe = data.OznakaSluzbe;
                    window.OznakaOS = data.OznakaOS;
                    window.CPU = data.CPU;
                    window.RAM = data.RAM;
                    window.DiskC = data.DiskC;
                    window.DiskD = data.DiskD;
                    window.SerijskaStevilka = data.SerijskaStevilka;
                    window.DatumProizvodnje = formatDateForInput(data.DatumProizvodnje);
                    window.DatumNakupa = formatDateForInput(data.DatumNakupa);
                    window.Opombe = data.Opombe;
                    
                    console.log('DatumProizvodnje after format:', window.DatumProizvodnje);
                    console.log('DatumNakupa after format:', window.DatumNakupa);

                    document.getElementById('OznakaDP').value = window.OznakaDP;
                    document.getElementById('ModelDP').value = window.ModelDP;
                    document.getElementById('OznakaProizvajalca').value = window.OznakaProizvajalca;
                    document.getElementById('OznakaTipaNaprave').value = window.OznakaTipaNaprave;
                    document.getElementById('OznakaLokacije').value = window.OznakaLokacije;
                    document.getElementById('InventarnaStevilka').value = window.InventarnaStevilka;
                    document.getElementById('OznakaOsebeUporabniskoIme').value = window.OznakaOsebeUporabniskoIme;
                    document.getElementById('OznakaEnote').value = window.OznakaEnote;
                    document.getElementById('OznakaSluzbe').value = window.OznakaSluzbe;
                    document.getElementById('OznakaOS').value = window.OznakaOS;
                    document.getElementById('CPU').value = window.CPU;
                    document.getElementById('RAM').value = window.RAM;
                    document.getElementById('DiskC').value = window.DiskC;
                    document.getElementById('DiskD').value = window.DiskD;
                    document.getElementById('SerijskaStevilka').value = window.SerijskaStevilka;
                    document.getElementById('DatumProizvodnje').value = window.DatumProizvodnje;
                    document.getElementById('DatumNakupa').value = window.DatumNakupa;
                    document.getElementById('Opombe').value = window.Opombe;
                })

                document.addEventListener('submit', (event) => {
                    event.preventDefault();
                    const form = event.target;
                    const payload = {
                        OznakaDP: form.OznakaDP.value,
                        ModelDP: form.ModelDP.value,
                        OznakaProizvajalca: form.OznakaProizvajalca.value,
                        OznakaTipaNaprave: form.OznakaTipaNaprave.value,
                        OznakaLokacije: form.OznakaLokacije.value,
                        InventarnaStevilka: form.InventarnaStevilka.value,
                        OznakaOsebeUporabniskoIme: form.OznakaOsebeUporabniskoIme.value,
                        OznakaEnote: form.OznakaEnote.value,
                        OznakaSluzbe: form.OznakaSluzbe.value,
                        OznakaOS: form.OznakaOS.value,
                        CPU: form.CPU.value,
                        RAM: form.RAM.value,
                        DiskC: form.DiskC.value,
                        DiskD: form.DiskD.value,
                        SerijskaStevilka: form.SerijskaStevilka.value,
                        DatumProizvodnje: form.DatumProizvodnje.value,
                        DatumNakupa: form.DatumNakupa.value,
                        Opombe: form.Opombe.value,
                        ID: window.OznakaDP
                    };
                    fetch('/urediDelovnaPostaja', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    })
                    .then(response => {
                        if (response.ok) {
                            alert('Delovna postaja uspeÅ¡no urejena!');
                            window.location.href = '/opremaPregled';
                        } else {
                            response.json().then(j => console.error(j)).catch(()=>{});
                            alert('Napaka pri urejanju delovne postaje.');
                        }
                    })
                    .catch(error => {
                        console.error('Error submitting form:', error);
                        alert('Napaka pri urejanju delovne postaje.');
                    });
                });

                document.addEventListener('reset', (e) => {
                    e.preventDefault();
                    document.getElementById('OznakaDP').value = window.OznakaDP;
                    document.getElementById('ModelDP').value = window.ModelDP;
                    document.getElementById('OznakaProizvajalca').value = window.OznakaProizvajalca;
                    document.getElementById('OznakaTipaNaprave').value = window.OznakaTipaNaprave;
                    document.getElementById('OznakaLokacije').value = window.OznakaLokacije;
                    document.getElementById('InventarnaStevilka').value = window.InventarnaStevilka;
                    document.getElementById('OznakaOsebeUporabniskoIme').value = window.OznakaOsebeUporabniskoIme;
                    document.getElementById('OznakaEnote').value = window.OznakaEnote;
                    document.getElementById('OznakaSluzbe').value = window.OznakaSluzbe;
                    document.getElementById('OznakaOS').value = window.OznakaOS;
                    document.getElementById('CPU').value = window.CPU;
                    document.getElementById('RAM').value = window.RAM;
                    document.getElementById('DiskC').value = window.DiskC;
                    document.getElementById('DiskD').value = window.DiskD;
                    document.getElementById('SerijskaStevilka').value = window.SerijskaStevilka;
                    document.getElementById('DatumProizvodnje').value = window.DatumProizvodnje;
                    document.getElementById('DatumNakupa').value = window.DatumNakupa;
                    document.getElementById('Opombe').value = window.Opombe;
                });
            });
</script>
</body>
</html>
